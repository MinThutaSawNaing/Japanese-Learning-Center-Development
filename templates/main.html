<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Learning Portal</title>
    <link rel="icon" type="image/png" href="..\static\images\icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e74c3c;
            --primary-dark: #c0392b;
            --primary-light: #ec7063;
            --secondary-color: #3498db;
            --secondary-dark: #2980b9;
            --accent-color: #f39c12;
            --text-color: #2c3e50;
            --light-gray: #ecf0f1;
            --medium-gray: #bdc3c7;
            --dark-gray: #7f8c8d;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --beige: #f8f9fa;
            --white: #ffffff;
            --gradient-primary: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --gradient-secondary: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --gradient-accent: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
            background-color: var(--beige);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background-color: var(--white);
            box-shadow: var(--shadow-md);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .logo span {
            font-size: 28px;
            margin-right: 10px;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo img {
            margin-right: 10px;
            height: 60px;
            width: auto;
        }
        
        nav {
            display: flex;
            align-items: center;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        
        nav ul li {
            margin-left: 25px;
            position: relative;
        }
        
        nav ul li a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            font-size: 16px;
            transition: color 0.3s ease;
            position: relative;
            padding: 5px 0;
        }
        
        nav ul li a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }
        
        nav ul li a:hover {
            color: var(--primary-color);
        }
        
        nav ul li a:hover::after {
            width: 100%;
        }
        
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            z-index: 2001;
            position: relative;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            z-index: 1;
            font-size: 16px;
            min-height: 48px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-secondary);
            z-index: -1;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:hover::before {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline::before {
            background: var(--gradient-primary);
        }
        
        .btn-outline:hover {
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-success:hover {
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-warning:hover {
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .section {
            margin: 40px 0;
            animation: fadeIn 0.8s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            font-size: 28px;
            margin-bottom: 25px;
            color: var(--primary-color);
            text-align: center;
            position: relative;
            font-weight: 700;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }
        
        .auth-container {
            max-width: 450px;
            margin: 0 auto;
            background-color: var(--white);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            min-height: 48px;
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .captcha-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .captcha-display {
            background-color: var(--light-gray);
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 18px;
            letter-spacing: 3px;
            user-select: none;
            min-width: 100px;
            text-align: center;
        }
        
        .refresh-captcha {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            transition: transform 0.3s ease;
        }
        
        .refresh-captcha:hover {
            transform: rotate(90deg);
        }
        
        .form-toggle {
            text-align: center;
            margin-top: 20px;
        }
        
        .form-toggle a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .form-toggle a:hover {
            text-decoration: underline;
        }
        
        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .course-card {
            background-color: var(--white);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .course-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }
        
        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .course-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            position: relative;
        }
        
        .course-header::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 30px;
            background-color: var(--white);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
        }
        
        .course-body {
            padding: 30px 20px 20px;
        }
        
        .course-description {
            margin-bottom: 20px;
            color: var(--dark-gray);
            text-align: center;
            font-size: 14px;
        }
        
        .course-status {
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            width: 100%;
            font-size: 14px;
        }
        
        .course-status.purchased {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .course-status.pending {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }
        
        .course-status.rejected {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }
        
        .modal-content {
            background-color: var(--white);
            padding: 0;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            position: relative;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-height: 48px;
        }
        
        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 25px;
            max-height: calc(90vh - 80px);
            overflow-y: auto;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: var(--beige);
            border-radius: 10px;
        }
        
        .qr-container img {
            max-width: 250px;
            height: auto;
            border-radius: 10px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
        }
        
        .qr-container img:hover {
            transform: scale(1.05);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            max-width: 90%;
            left: 20px;
            right: 20px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification i {
            margin-right: 10px;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--white);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .admin-table th, .admin-table td {
            padding: 12px 10px;
            text-align: left;
            font-size: 14px;
        }
        
        .admin-table th {
            background: var(--gradient-primary);
            color: white;
            font-weight: 600;
        }
        
        .admin-table tr:nth-child(even) {
            background-color: rgba(236, 240, 241, 0.5);
        }
        
        .admin-table tr:hover {
            background-color: rgba(236, 240, 241, 0.8);
        }
        
        .admin-table tr.new-purchase {
            animation: highlightNewRow 2s ease;
        }
        
        @keyframes highlightNewRow {
            0% { background-color: rgba(46, 204, 113, 0.3); }
            100% { background-color: transparent; }
        }
        
        .admin-table tr.updated-purchase {
            animation: highlightUpdatedRow 2s ease;
        }
        
        @keyframes highlightUpdatedRow {
            0% { background-color: rgba(52, 152, 219, 0.3); }
            100% { background-color: transparent; }
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .status-badge.pending {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }
        
        .status-badge.approved {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--success-color);
        }
        
        .status-badge.rejected {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
        }
        
        .status-badge.replied {
            background-color: rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            padding: 8px 12px;
            font-size: 12px;
            min-height: auto;
        }
        
        .hero {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.9) 0%, rgba(192, 57, 43, 0.9) 100%), url('https://images.unsplash.com/photo-1528164344705-47542687000d?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1170&q=80') center/cover;
            padding: 60px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 0 0 20px 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 90%);
        }
        
        .hero h1 {
            font-size: 32px;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }
        
        .hero p {
            font-size: 16px;
            max-width: 800px;
            margin: 0 auto 25px;
            position: relative;
            z-index: 1;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .feature {
            text-align: center;
            background-color: var(--white);
            padding: 25px 15px;
            border-radius: 15px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .feature::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient-primary);
        }
        
        .feature:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .feature-icon {
            font-size: 40px;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: inline-block;
            padding: 15px;
            border-radius: 50%;
            background-color: rgba(231, 76, 60, 0.1);
        }
        
        .feature h3 {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 18px;
        }
        
        .feature p {
            font-size: 14px;
        }
        
        .quiz-container {
            background-color: var(--white);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
        }
        
        .quiz-question {
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quiz-option {
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quiz-option:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: var(--secondary-color);
        }
        
        .quiz-option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .quiz-result {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 500;
        }
        
        .quiz-result.success {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .quiz-result.error {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .resources {
            background-color: var(--white);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: var(--shadow-md);
        }
        
        .resource-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .resource-item:last-child {
            border-bottom: none;
        }
        
        .resource-item:hover {
            padding-left: 10px;
        }
        
        .resource-item i {
            margin-right: 15px;
            color: var(--primary-color);
            font-size: 18px;
        }
        
        .resource-item a {
            color: var(--text-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .resource-item a:hover {
            color: var(--primary-color);
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }
        
        .connection-status.disconnected {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }
        
        .connection-status i {
            font-size: 10px;
        }
        
        .connection-status.connecting {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }
        
        /* Support section styles */
        .support-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .support-option {
            background-color: var(--white);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .support-option:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }
        
        .support-option i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .support-option h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .support-option p {
            color: var(--dark-gray);
            font-size: 14px;
        }
        
        .support-form {
            background-color: var(--white);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        
        .support-form.active {
            display: block;
        }
        
        .support-message {
            background-color: var(--white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-md);
        }
        
        .support-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .support-message-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .support-message-type.teacher {
            background-color: rgba(52, 152, 219, 0.2);
            color: var(--secondary-color);
        }
        
        .support-message-type.support {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--warning-color);
        }
        
        .support-message-subject {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .support-message-content {
            margin-bottom: 10px;
        }
        
        .support-message-footer {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        .reply-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--dark-gray);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary-color);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .message-list {
            background-color: var(--white);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .message-item {
            background-color: var(--beige);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .message-item.sent {
            background-color: var(--primary-color);
            color: white;
            margin-left: 20%;
        }
        
        .message-item.received {
            background-color: var(--white);
            color: var(--text-color);
            margin-right: 20%;
            border: 1px solid var(--light-gray);
        }
        
        .message-header {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .message-content {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        
        .message-time {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .file-attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 10px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .file-attachment:hover {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .file-attachment i {
            font-size: 16px;
        }
        
        /* Teacher message view modal */
        .teacher-message-modal .modal-body {
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .teacher-message-detail {
            background-color: var(--beige);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .teacher-message-subject {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .teacher-message-content {
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .teacher-message-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--dark-gray);
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            nav {
                position: fixed;
                top: 0;
                left: -100%;
                width: 80%;
                height: 100vh;
                background-color: var(--white);
                box-shadow: var(--shadow-xl);
                transition: left 0.3s ease;
                z-index: 1000;
                overflow-y: auto;
            }
            
            nav.active {
                left: 0;
            }
            
            nav ul {
                flex-direction: column;
                padding: 70px 20px 20px;
                width: 100%;
            }
            
            nav ul li {
                margin: 0 0 20px 0;
                border-bottom: 1px solid var(--light-gray);
                padding-bottom: 15px;
            }
            
            nav ul li:last-child {
                border-bottom: none;
                margin-bottom: 0;
                padding-bottom: 0;
            }
            
            nav ul li a {
                font-size: 18px;
                padding: 10px 0;
                display: block;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo img {
                height: 50px;
            }
            
            .hero h1 {
                font-size: 28px;
            }
            
            .hero p {
                font-size: 15px;
            }
            
            .section-title {
                font-size: 24px;
            }
            
            .courses-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .course-header {
                font-size: 20px;
                padding: 15px;
            }
            
            .course-body {
                padding: 25px 15px 15px;
            }
            
            .course-description {
                font-size: 13px;
            }
            
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-title {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .notification {
                font-size: 14px;
                padding: 12px 15px;
            }
            
            .admin-table {
                font-size: 12px;
            }
            
            .admin-table th, .admin-table td {
                padding: 8px 5px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .action-buttons .btn {
                width: 100%;
                padding: 8px 10px;
            }
            
            .status-badge {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .quiz-options {
                grid-template-columns: 1fr;
            }
            
            .quiz-option {
                padding: 12px;
                font-size: 14px;
            }
            
            .feature {
                padding: 20px 15px;
            }
            
            .feature-icon {
                font-size: 35px;
                padding: 12px;
            }
            
            .feature h3 {
                font-size: 16px;
            }
            
            .feature p {
                font-size: 13px;
            }
            
            .auth-container {
                padding: 25px 20px;
            }
            
            .form-group input, .form-group textarea, .form-group select {
                padding: 12px;
                font-size: 16px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .connection-status {
                bottom: 15px;
                left: 15px;
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .support-options {
                grid-template-columns: 1fr;
            }
            
            .message-item.sent {
                margin-left: 10%;
            }
            
            .message-item.received {
                margin-right: 10%;
            }
        }
        
        /* Small mobile devices */
        @media (max-width: 480px) {
            .hero {
                padding: 40px 0;
            }
            
            .hero h1 {
                font-size: 24px;
            }
            
            .hero p {
                font-size: 14px;
            }
            
            .section {
                margin: 30px 0;
            }
            
            .section-title {
                font-size: 22px;
            }
            
            .features {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .feature {
                padding: 15px;
            }
            
            .feature-icon {
                font-size: 30px;
                padding: 10px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .qr-container img {
                max-width: 200px;
            }
            
            .admin-table {
                font-size: 11px;
            }
            
            .admin-table th, .admin-table td {
                padding: 6px 3px;
            }
            
            .action-buttons .btn {
                padding: 6px 8px;
                font-size: 11px;
            }
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Floating elements */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        /* Pulse animation */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }
        
        /* Swipe indicator */
        .swipe-indicator {
            position: fixed;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            width: 4px;
            height: 60px;
            background-color: rgba(231, 76, 60, 0.5);
            border-radius: 2px;
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .swipe-indicator.show {
            opacity: 1;
        }
        
        /* QR Code loading state */
        .qr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 250px;
            background-color: var(--beige);
            border-radius: 10px;
        }
        
        .qr-loading .loading {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="../static/images/logohn.jpg" alt="logo"/>
                    Han Nay Japanese Language Center
                </div>
                <button class="mobile-menu-toggle" id="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <nav id="main-nav">
                    <ul>
                        <li><a href="#" id="home-link">Home</a></li>
                        <li><a href="#" id="courses-link">Courses</a></li>
                        <li><a href="#" id="support-link" style="display: none;">Support</a></li>
                        <li><a href="#" id="login-link" style="display: none;">Login</a></li>
                        <li><a href="#" id="register-link" style="display: none;">Register</a></li>
                        <li><a href="#" id="logout-link" style="display: none;">Logout</a></li>
                        <li><a href="#" id="admin-link" style="display: none;">Admin</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Overlay for mobile menu -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Swipe indicator -->
    <div class="swipe-indicator" id="swipe-indicator"></div>

    <main class="container">
        <!-- Home Section -->
        <section id="home-section" class="section">
            <div class="hero">
                <h1>Master Japanese Language</h1>
                <p>Learn Japanese from N5 to N1 with our comprehensive courses. Start your journey today!</p>
                <button class="btn pulse" id="get-started-btn">Get Started</button>
            </div>
            
            <div class="features">
                <div class="feature floating">
                    <div class="feature-icon"><i class="fas fa-book"></i></div>
                    <h3>Comprehensive Courses</h3>
                    <p>From beginner to advanced levels covering all aspects of Japanese language.</p>
                </div>
                <div class="feature floating" style="animation-delay: 0.2s;">
                    <div class="feature-icon"><i class="fas fa-bullseye"></i></div>
                    <h3>JLPT Focused</h3>
                    <p>Prepare for JLPT exams with our structured N5 to N1 courses.</p>
                </div>
                <div class="feature floating" style="animation-delay: 0.4s;">
                    <div class="feature-icon"><i class="fas fa-credit-card"></i></div>
                    <h3>Easy Payment</h3>
                    <p>Secure payment through KBZ Pay with instant access after approval.</p>
                </div>
                <div class="feature floating" style="animation-delay: 0.6s;">
                    <div class="feature-icon"><i class="fas fa-trophy"></i></div>
                    <h3>Track Progress</h3>
                    <p>Monitor your learning progress with quizzes and assessments.</p>
                </div>
            </div>
        </section>

        <!-- Login/Register Section -->
        <section id="auth-section" class="section" style="display: none;">
            <div class="auth-container">
                <div id="login-form">
                    <h2 class="section-title">Login</h2>
                    <form id="login-form-element">
                        <div class="form-group">
                            <label for="login-email"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="login-email" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="login-password" required>
                        </div>
                        <div class="form-group">
                            <label for="login-captcha"><i class="fas fa-shield-alt"></i> CAPTCHA</label>
                            <div class="captcha-container">
                                <input type="text" id="login-captcha" placeholder="Enter the code" required>
                                <div class="captcha-display" id="login-captcha-display">1234</div>
                                <button type="button" class="refresh-captcha" id="refresh-login-captcha">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Login</button>
                    </form>
                    <div class="form-toggle">
                        Don't have an account? <a href="#" id="show-register">Register</a>
                    </div>
                </div>
                
                <div id="register-form" style="display: none;">
                    <h2 class="section-title">Register</h2>
                    <form id="register-form-element">
                        <div class="form-group">
                            <label for="register-email"><i class="fas fa-envelope"></i> Email</label>
                            <input type="email" id="register-email" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password"><i class="fas fa-lock"></i> Password</label>
                            <input type="password" id="register-password" required>
                        </div>
                        <div class="form-group">
                            <label for="register-captcha"><i class="fas fa-shield-alt"></i> CAPTCHA</label>
                            <div class="captcha-container">
                                <input type="text" id="register-captcha" placeholder="Enter the code" required>
                                <div class="captcha-display" id="register-captcha-display">1234</div>
                                <button type="button" class="refresh-captcha" id="refresh-register-captcha">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Register</button>
                    </form>
                    <div class="form-toggle">
                        Already have an account? <a href="#" id="show-login">Login</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Courses Section -->
        <section id="courses-section" class="section" style="display: none;">
            <h2 class="section-title">Japanese Courses</h2>
            <div id="courses-container" class="courses-grid">
                <!-- Courses will be loaded here -->
            </div>
        </section>

        <!-- Support Section -->
        <section id="support-section" class="section" style="display: none;">
            <h2 class="section-title">Support Center</h2>
            
            <div class="tabs">
                <div class="tab active" id="support-messages-tab">Support Messages</div>
                <div class="tab" id="teacher-messages-tab">Ask Teacher</div>
                <div class="tab" id="new-message-tab">New Message</div>
            </div>
            
            <div class="tab-content active" id="support-messages-content">
                <div class="message-list" id="support-messages-list">
                    <!-- Support messages will be loaded here -->
                </div>
            </div>
            
            <div class="tab-content" id="teacher-messages-content">
                <div class="message-list" id="teacher-messages-list">
                    <!-- Teacher messages will be loaded here -->
                </div>
            </div>
            
            <div class="tab-content" id="new-message-content">
                <div class="support-options">
                    <div class="support-option" id="get-support-option">
                        <i class="fas fa-headset"></i>
                        <h3>Get Support</h3>
                        <p>Need technical help or have account issues? Contact our support team.</p>
                    </div>
                    <div class="support-option" id="ask-teacher-option">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <h3>Ask Teacher</h3>
                        <p>Get help with your Japanese language questions from our teachers.</p>
                    </div>
                </div>
                
                <div class="support-form" id="support-form-container">
                    <h3 id="support-form-title">Send Message</h3>
                    <form id="support-form-element">
                        <div class="form-group">
                            <label for="support-subject"><i class="fas fa-heading"></i> Subject</label>
                            <input type="text" id="support-subject" required>
                        </div>
                        <div class="form-group">
                            <label for="support-message"><i class="fas fa-comment"></i> Message</label>
                            <textarea id="support-message" required></textarea>
                        </div>
                        <div class="form-group" id="file-upload-group" style="display: none;">
                            <label for="support-file"><i class="fas fa-paperclip"></i> Attachment (Optional)</label>
                            <input type="file" id="support-file" accept=".docx,.pdf,.txt,.jpeg,.jpg,.png">
                            <small>Allowed formats: DOCX, PDF, TXT, JPEG, PNG (Max 10MB)</small>
                        </div>
                        <input type="hidden" id="support-type" value="">
                        <button type="submit" class="btn" style="width: 100%;">Send Message</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Login Section -->
        <section id="admin-login-section" class="section" style="display: none;">
            <div class="auth-container">
                <h2 class="section-title">Admin Login</h2>
                <form id="admin-login-form-element">
                    <div class="form-group">
                        <label for="admin-email"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="admin-email" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-password"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="admin-password" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-captcha"><i class="fas fa-shield-alt"></i> CAPTCHA</label>
                        <div class="captcha-container">
                            <input type="text" id="admin-captcha" placeholder="Enter the code" required>
                            <div class="captcha-display" id="admin-captcha-display">1234</div>
                            <button type="button" class="refresh-captcha" id="refresh-admin-captcha">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn" style="width: 100%;">Login</button>
                </form>
            </div>
        </section>

        <!-- Admin Dashboard Section -->
        <section id="admin-dashboard-section" class="section" style="display: none;">
            <h2 class="section-title">Admin Dashboard</h2>
            
            <div class="tabs">
                <div class="tab active" id="purchases-tab">Purchases</div>
                <div class="tab" id="support-tab">Support Messages</div>
                <div class="tab" id="teacher-tab">Teacher Messages</div>
            </div>
            
            <div class="tab-content active" id="purchases-content">
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User Email</th>
                                <th>Course</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-purchases-tbody">
                            <!-- Purchases will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="support-content">
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User Email</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-support-tbody">
                            <!-- Support messages will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="teacher-content">
                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User Email</th>
                                <th>Subject</th>
                                <th>File</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-teacher-tbody">
                            <!-- Teacher messages will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Course Modal -->
    <div id="course-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-course-title">Course Title</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-course-description"></div>
                <div id="modal-course-content"></div>
                <div id="modal-resources-section" style="display: none;">
                    <h4><i class="fas fa-folder-open"></i> Course Resources</h4>
                    <div class="resources">
                        <div class="resource-item">
                            <i class="fas fa-file-pdf"></i>
                            <a href="#" target="_blank">Textbook PDF</a>
                        </div>
                        <div class="resource-item">
                            <i class="fas fa-camera"></i>
                            <a href="#" target="_blank">Videos Materials</a>
                        </div>
                        <div class="resource-item">
                            <i class="fas fa-pencil-alt"></i>
                            <a href="#" target="_blank">Practice Exercises</a>
                        </div>
                        <div class="resource-item">
                            <i class="fas fa-list"></i>
                            <a href="#" target="_blank">Vocabulary List</a>
                        </div>
                    </div>
                </div>
                <div id="modal-purchase-section" style="display: none;">
                    <h4><i class="fas fa-qrcode"></i> Purchase via KBZ Pay</h4>
                    <div class="qr-container">
                        <div id="qr-loading" class="qr-loading" style="display: none;">
                            <div class="loading"></div>
                        </div>
                        <img id="modal-qr-code" src="" alt="KBZ Pay QR Code" style="display: none;">
                    </div>
                    <p>Scan the QR code with KBZ Pay app to complete the payment.</p>
                    <button class="btn" id="ive-paid-btn">I've Paid</button>
                </div>
                <div id="modal-quiz-section" style="display: none;">
                    <h4><i class="fas fa-question-circle"></i> Quiz</h4>
                    <div class="quiz-container">
                        <div class="quiz-question" id="quiz-question"></div>
                        <div class="quiz-options" id="quiz-options"></div>
                        <button class="btn" id="submit-quiz-btn">Submit</button>
                        <div id="quiz-result" class="quiz-result" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Reply Modal -->
    <div id="support-reply-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Reply to Support Message</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="support-message">
                    <div class="support-message-header">
                        <span class="support-message-type" id="reply-message-type"></span>
                        <span id="reply-message-email"></span>
                    </div>
                    <div class="support-message-subject" id="reply-message-subject"></div>
                    <div class="support-message-content" id="reply-message-content"></div>
                    <div class="support-message-footer">
                        <span id="reply-message-date"></span>
                    </div>
                </div>
                
                <form id="reply-form-element">
                    <div class="form-group">
                        <label for="reply-message"><i class="fas fa-reply"></i> Your Reply</label>
                        <textarea id="reply-message" required></textarea>
                    </div>
                    <input type="hidden" id="reply-message-id" value="">
                    <input type="hidden" id="reply-message-type-field" value="">
                    <button type="submit" class="btn" style="width: 100%;">Send Reply</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Teacher Message View Modal -->
    <div id="teacher-message-modal" class="modal teacher-message-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Teacher Message Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="teacher-message-detail">
                    <div class="teacher-message-subject" id="teacher-view-subject"></div>
                    <div class="teacher-message-content" id="teacher-view-message"></div>
                    <div class="teacher-message-meta">
                        <span id="teacher-view-email"></span>
                        <span id="teacher-view-date"></span>
                    </div>
                    <div id="teacher-view-file-container" style="margin-top: 15px;"></div>
                </div>
                
                <div id="teacher-reply-section" style="margin-top: 20px; display: none;">
                    <h4>Teacher's Reply:</h4>
                    <div id="teacher-view-reply" style="background-color: var(--beige); padding: 15px; border-radius: 10px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notification-message"></span>
    </div>

    <!-- Connection Status -->
    <div id="connection-status" class="connection-status disconnected">
        <i class="fas fa-circle"></i>
        <span>Disconnected</span>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let currentCourse = null;
        let socket = null;
        let isProcessing = false;
        let quizQuestions = [
            {
                question: "What does 'arigatou' mean?",
                options: ["Hello", "Thank you", "Goodbye", "Sorry"],
                correct: 1
            },
            {
                question: "How do you say 'good morning' in Japanese?",
                options: ["Konnichiwa", "Konbanwa", "Ohayou", "Sayonara"],
                correct: 2
            },
            {
                question: "What is the Japanese word for 'water'?",
                options: ["Mizu", "Hon", "Terebi", "Denwa"],
                correct: 0
            }
        ];
        let currentQuizQuestion = 0;
        let quizScore = 0;
        
        // Touch/swipe variables
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        let swipeIndicator = document.getElementById('swipe-indicator');
        let swipeIndicatorTimeout;

        // DOM elements
        const homeSection = document.getElementById('home-section');
        const authSection = document.getElementById('auth-section');
        const coursesSection = document.getElementById('courses-section');
        const supportSection = document.getElementById('support-section');
        const adminLoginSection = document.getElementById('admin-login-section');
        const adminDashboardSection = document.getElementById('admin-dashboard-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const courseModal = document.getElementById('course-modal');
        const supportReplyModal = document.getElementById('support-reply-modal');
        const teacherMessageModal = document.getElementById('teacher-message-modal');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');
        const connectionStatus = document.getElementById('connection-status');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mainNav = document.getElementById('main-nav');
        const overlay = document.getElementById('overlay');

        // Navigation links
        const homeLink = document.getElementById('home-link');
        const coursesLink = document.getElementById('courses-link');
        const supportLink = document.getElementById('support-link');
        const loginLink = document.getElementById('login-link');
        const registerLink = document.getElementById('register-link');
        const logoutLink = document.getElementById('logout-link');
        const adminLink = document.getElementById('admin-link');
        
        // Support elements
        const getSupportOption = document.getElementById('get-support-option');
        const askTeacherOption = document.getElementById('ask-teacher-option');
        const supportFormContainer = document.getElementById('support-form-container');
        const supportFormTitle = document.getElementById('support-form-title');
        const supportType = document.getElementById('support-type');
        const fileUploadGroup = document.getElementById('file-upload-group');
        
        // Support tabs
        const supportMessagesTab = document.getElementById('support-messages-tab');
        const teacherMessagesTab = document.getElementById('teacher-messages-tab');
        const newMessageTab = document.getElementById('new-message-tab');
        const supportMessagesContent = document.getElementById('support-messages-content');
        const teacherMessagesContent = document.getElementById('teacher-messages-content');
        const newMessageContent = document.getElementById('new-message-content');
        
        // Admin dashboard tabs
        const purchasesTab = document.getElementById('purchases-tab');
        const supportTab = document.getElementById('support-tab');
        const teacherTab = document.getElementById('teacher-tab');
        const purchasesContent = document.getElementById('purchases-content');
        const supportContent = document.getElementById('support-content');
        const teacherContent = document.getElementById('teacher-content');
        
        // Course resources for each level
        const courseResources = {
            'N5': {
                textbook: 'https://example.com/n5-textbook.pdf',
                video: 'https://u.pcloud.link/publink/show?code=kZnrMn5ZBNlpnTKl0ljS5zraqrb2WRSwISL7',
                exercise: 'https://example.com/n5-exercises',
                vocabulary: 'https://example.com/n5-vocabulary'
            },
            'N4': {
                textbook: 'https://example.com/n4-textbook.pdf',
                video: 'https://u.pcloud.link/publink/show?code=kZIrMn5ZCljUyxeGDISXjL3g1gTSCbqwkbfV',
                exercise: 'https://example.com/n4-exercises',
                vocabulary: 'https://example.com/n4-vocabulary'
            },
            'N3': {
                textbook: 'https://example.com/n3-textbook.pdf',
                video: 'https://u.pcloud.link/publink/show?code=kZirMn5ZgexKgOmYo0pUgnSBzqBHzSrVQumy',
                exercise: 'https://example.com/n3-exercises',
                vocabulary: 'https://example.com/n3-vocabulary'
            },
            'N2': {
                textbook: 'https://example.com/n2-textbook.pdf',
                video: 'https://example.com/n2-videos',
                exercise: 'https://example.com/n2-exercises',
                vocabulary: 'https://example.com/n2-vocabulary'
            },
            'N1': {
                textbook: 'https://example.com/n1-textbook.pdf',
                video: 'https://example.com/n1-videos',
                exercise: 'https://example.com/n1-exercises',
                vocabulary: 'https://example.com/n1-vocabulary'
            }
        };

        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', () => {
            mainNav.classList.toggle('active');
            overlay.classList.toggle('active');
        });

        overlay.addEventListener('click', () => {
            mainNav.classList.remove('active');
            overlay.classList.remove('active');
        });

        // Close mobile menu when a link is clicked
        document.querySelectorAll('#main-nav a').forEach(link => {
            link.addEventListener('click', () => {
                mainNav.classList.remove('active');
                overlay.classList.remove('active');
            });
        });
        
        // Touch event handlers for swipe gestures
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
            
            // Show swipe indicator when touching near the left edge
            if (touchStartX < 20 && !mainNav.classList.contains('active')) {
                swipeIndicator.classList.add('show');
                
                // Clear any existing timeout
                if (swipeIndicatorTimeout) {
                    clearTimeout(swipeIndicatorTimeout);
                }
                
                // Hide indicator after 1 second
                swipeIndicatorTimeout = setTimeout(() => {
                    swipeIndicator.classList.remove('show');
                }, 1000);
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
            
            // Hide swipe indicator
            swipeIndicator.classList.remove('show');
            
            // Clear timeout if it exists
            if (swipeIndicatorTimeout) {
                clearTimeout(swipeIndicatorTimeout);
            }
        }, { passive: true });
        
        function handleSwipe() {
            // Calculate horizontal distance
            const swipeDistance = touchEndX - touchStartX;
            
            // Minimum distance required for a swipe
            const minSwipeDistance = 50;
            
            // Check if it's a horizontal swipe (not vertical)
            const verticalDistance = Math.abs(touchEndY - touchStartY);
            const isHorizontalSwipe = Math.abs(swipeDistance) > verticalDistance;
            
            if (isHorizontalSwipe) {
                // Swipe right to open menu
                if (swipeDistance > minSwipeDistance && touchStartX < 30) {
                    mainNav.classList.add('active');
                    overlay.classList.add('active');
                }
                // Swipe left to close menu
                else if (swipeDistance < -minSwipeDistance && mainNav.classList.contains('active')) {
                    mainNav.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
        }

        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io({
                transports: ['websocket', 'polling'],
                upgrade: true,
                rememberUpgrade: true
            });
            
            socket.on('connect', () => {
                console.log('Connected to server');
                updateConnectionStatus('connected');
                
                // Join appropriate room if logged in
                if (currentUser) {
                    if (currentUser.is_admin) {
                        socket.emit('join_admin_room');
                    } else {
                        socket.emit('join_user_room', {user_id: currentUser.id});
                    }
                }
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateConnectionStatus('disconnected');
            });
            
            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                updateConnectionStatus('disconnected');
            });
            
            socket.on('reconnecting', () => {
                console.log('Reconnecting...');
                updateConnectionStatus('connecting');
            });
            
            socket.on('reconnect', () => {
                console.log('Reconnected to server');
                updateConnectionStatus('connected');
                
                // Re-join room after reconnection
                if (currentUser) {
                    if (currentUser.is_admin) {
                        socket.emit('join_admin_room');
                    } else {
                        socket.emit('join_user_room', {user_id: currentUser.id});
                    }
                }
            });
            
            // Listen for initial purchases (admin only)
            socket.on('initial_purchases', (data) => {
                if (currentUser && currentUser.is_admin && data.purchases) {
                    loadPurchasesIntoTable(data.purchases);
                }
            });
            
            // Listen for initial support messages (admin only)
            socket.on('initial_support_messages', (data) => {
                if (currentUser && currentUser.is_admin && data.messages) {
                    loadSupportMessagesIntoTable(data.messages);
                }
            });
            
            // Listen for initial teacher messages (admin only)
            socket.on('initial_teacher_messages', (data) => {
                if (currentUser && currentUser.is_admin && data.messages) {
                    loadTeacherMessagesIntoTable(data.messages);
                }
            });
            
            // Listen for new purchases (admin only)
            socket.on('new_purchase', (data) => {
                if (currentUser && currentUser.is_admin) {
                    addNewPurchaseToTable(data);
                    showNotification(`New purchase request from ${data.user_email} for ${data.course_level}`, 'info');
                }
            });
            
            // Listen for new support messages (admin only)
            socket.on('new_support_message', (data) => {
                if (currentUser && currentUser.is_admin) {
                    addNewSupportMessageToTable(data);
                    showNotification(`New support message from ${data.user_email}: ${data.subject}`, 'info');
                }
            });
            
            // Listen for new teacher messages (admin only)
            socket.on('new_teacher_message', (data) => {
                if (currentUser && currentUser.is_admin) {
                    addNewTeacherMessageToTable(data);
                    showNotification(`New teacher message from ${data.user_email}: ${data.subject}`, 'info');
                }
            });
            
            // Listen for purchase updates (admin only)
            socket.on('purchase_updated', (data) => {
                if (currentUser && currentUser.is_admin) {
                    updatePurchaseInTable(data.purchase, data.action);
                    showNotification(`Purchase ${data.action} successfully`, 'success');
                }
            });
            
            // Listen for support message updates (admin only)
            socket.on('support_message_updated', (data) => {
                if (currentUser && currentUser.is_admin) {
                    updateSupportMessageInTable(data.message, data.action);
                    showNotification(`Support message ${data.action} successfully`, 'success');
                }
            });
            
            // Listen for teacher message updates (admin only)
            socket.on('teacher_message_updated', (data) => {
                if (currentUser && currentUser.is_admin) {
                    updateTeacherMessageInTable(data.message, data.action);
                    showNotification(`Teacher message ${data.action} successfully`, 'success');
                }
            });
            
            // Listen for purchase status changes (user only)
            socket.on('purchase_status_changed', (data) => {
                if (currentUser && !currentUser.is_admin) {
                    updateCourseStatus(data.course_level, data.status);
                    showNotification(data.message || `Your purchase for ${data.course_level} has been ${data.status}`, 
                                   data.status === 'approved' ? 'success' : 'warning');
                    
                    // Update modal if it's open for this course
                    if (currentCourse && currentCourse.level === data.course_level) {
                        currentCourse.status = data.status;
                        currentCourse.purchased = true;
                        showCourseModal();
                    }
                }
            });
            
            // Listen for support replies (user only)
            socket.on('support_reply_received', (data) => {
                if (currentUser && !currentUser.is_admin) {
                    showNotification(data.message, 'info');
                    // Update the specific message in the UI
                    updateSupportMessageInUI(data.message_id, data.reply);
                }
            });
            
            // Listen for teacher replies (user only)
            socket.on('teacher_reply_received', (data) => {
                if (currentUser && !currentUser.is_admin) {
                    showNotification(data.message, 'info');
                    // Update the specific message in the UI
                    updateTeacherMessageInUI(data.message_id, data.reply);
                }
            });
            
            // Listen for room join confirmation
            socket.on('room_joined', (data) => {
                console.log(`Joined room: ${data.room}`);
            });
        }

        // Update connection status indicator
        function updateConnectionStatus(status) {
            connectionStatus.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Connected</span>';
                    break;
                case 'disconnected':
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Disconnected</span>';
                    break;
                case 'connecting':
                    connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>Connecting...</span>';
                    break;
            }
        }

        // Load CAPTCHA
        async function loadCaptcha() {
            try {
                const response = await fetch('/get-captcha');
                const data = await response.json();
                
                if (data.captcha) {
                    document.getElementById('login-captcha-display').textContent = data.captcha;
                    document.getElementById('register-captcha-display').textContent = data.captcha;
                    document.getElementById('admin-captcha-display').textContent = data.captcha;
                }
            } catch (error) {
                console.error('Error loading CAPTCHA:', error);
            }
        }

        // Event listeners
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('home');
        });

        coursesLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) {
                showSection('courses');
                loadCourses();
            } else {
                showNotification('Please login to view courses', 'warning');
                showSection('auth');
            }
        });

        supportLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentUser) {
                showSection('support');
                loadUserMessages();
            } else {
                showNotification('Please login to access support', 'warning');
                showSection('auth');
            }
        });

        loginLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('auth');
            showLoginForm();
        });

        registerLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('auth');
            showRegisterForm();
        });

        logoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });

        adminLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('admin-login');
        });

        document.getElementById('get-started-btn').addEventListener('click', () => {
            if (currentUser) {
                showSection('courses');
                loadCourses();
            } else {
                showSection('auth');
                showLoginForm();
            }
        });

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            showRegisterForm();
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            showLoginForm();
        });

        document.getElementById('login-form-element').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isProcessing) {
                login();
            }
        });

        document.getElementById('register-form-element').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isProcessing) {
                register();
            }
        });

        document.getElementById('admin-login-form-element').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isProcessing) {
                adminLogin();
            }
        });

        // Support form event listeners
        getSupportOption.addEventListener('click', () => {
            supportFormContainer.classList.add('active');
            supportFormTitle.textContent = 'Get Support';
            supportType.value = 'support';
            fileUploadGroup.style.display = 'none';
            document.getElementById('support-subject').focus();
        });

        askTeacherOption.addEventListener('click', () => {
            supportFormContainer.classList.add('active');
            supportFormTitle.textContent = 'Ask Teacher';
            supportType.value = 'teacher';
            fileUploadGroup.style.display = 'block';
            document.getElementById('support-subject').focus();
        });

        document.getElementById('support-form-element').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isProcessing) {
                submitSupportMessage();
            }
        });

        // Reply form event listener
        document.getElementById('reply-form-element').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!isProcessing) {
                submitReply();
            }
        });

        // Support tabs
        supportMessagesTab.addEventListener('click', () => {
            supportMessagesTab.classList.add('active');
            teacherMessagesTab.classList.remove('active');
            newMessageTab.classList.remove('active');
            supportMessagesContent.classList.add('active');
            teacherMessagesContent.classList.remove('active');
            newMessageContent.classList.remove('active');
        });

        teacherMessagesTab.addEventListener('click', () => {
            teacherMessagesTab.classList.add('active');
            supportMessagesTab.classList.remove('active');
            newMessageTab.classList.remove('active');
            teacherMessagesContent.classList.add('active');
            supportMessagesContent.classList.remove('active');
            newMessageContent.classList.remove('active');
        });

        newMessageTab.addEventListener('click', () => {
            newMessageTab.classList.add('active');
            supportMessagesTab.classList.remove('active');
            teacherMessagesTab.classList.remove('active');
            newMessageContent.classList.add('active');
            supportMessagesContent.classList.remove('active');
            teacherMessagesContent.classList.remove('active');
        });

        // Admin dashboard tabs
        purchasesTab.addEventListener('click', () => {
            purchasesTab.classList.add('active');
            supportTab.classList.remove('active');
            teacherTab.classList.remove('active');
            purchasesContent.classList.add('active');
            supportContent.classList.remove('active');
            teacherContent.classList.remove('active');
        });

        supportTab.addEventListener('click', () => {
            supportTab.classList.add('active');
            purchasesTab.classList.remove('active');
            teacherTab.classList.remove('active');
            supportContent.classList.add('active');
            purchasesContent.classList.remove('active');
            teacherContent.classList.remove('active');
        });

        teacherTab.addEventListener('click', () => {
            teacherTab.classList.add('active');
            purchasesTab.classList.remove('active');
            supportTab.classList.remove('active');
            teacherContent.classList.add('active');
            purchasesContent.classList.remove('active');
            supportContent.classList.remove('active');
        });

        // CAPTCHA refresh buttons
        document.getElementById('refresh-login-captcha').addEventListener('click', () => {
            loadCaptcha();
        });

        document.getElementById('refresh-register-captcha').addEventListener('click', () => {
            loadCaptcha();
        });

        document.getElementById('refresh-admin-captcha').addEventListener('click', () => {
            loadCaptcha();
        });

        document.querySelector('.close-modal').addEventListener('click', () => {
            courseModal.style.display = 'none';
            resetModal();
        });

        // Close support reply modal
        const closeSupportReplyModal = supportReplyModal.querySelector('.close-modal');
        closeSupportReplyModal.addEventListener('click', () => {
            supportReplyModal.style.display = 'none';
            document.getElementById('reply-form-element').reset();
        });

        // Close teacher message modal
        const closeTeacherMessageModal = teacherMessageModal.querySelector('.close-modal');
        closeTeacherMessageModal.addEventListener('click', () => {
            teacherMessageModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === courseModal) {
                courseModal.style.display = 'none';
                resetModal();
            }
            if (e.target === supportReplyModal) {
                supportReplyModal.style.display = 'none';
                document.getElementById('reply-form-element').reset();
            }
            if (e.target === teacherMessageModal) {
                teacherMessageModal.style.display = 'none';
            }
        });

        document.getElementById('ive-paid-btn').addEventListener('click', () => {
            if (!isProcessing) {
                markAsPaid();
            }
        });

        document.getElementById('submit-quiz-btn').addEventListener('click', () => {
            submitQuiz();
        });

        // Functions
        function showSection(section) {
            homeSection.style.display = 'none';
            authSection.style.display = 'none';
            coursesSection.style.display = 'none';
            supportSection.style.display = 'none';
            adminLoginSection.style.display = 'none';
            adminDashboardSection.style.display = 'none';

            switch(section) {
                case 'home':
                    homeSection.style.display = 'block';
                    break;
                case 'auth':
                    authSection.style.display = 'block';
                    break;
                case 'courses':
                    coursesSection.style.display = 'block';
                    break;
                case 'support':
                    supportSection.style.display = 'block';
                    break;
                case 'admin-login':
                    adminLoginSection.style.display = 'block';
                    break;
                case 'admin-dashboard':
                    adminDashboardSection.style.display = 'block';
                    break;
            }
            
            // Close mobile menu when changing sections
            mainNav.classList.remove('active');
            overlay.classList.remove('active');
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            loadCaptcha();
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            loadCaptcha();
        }

        function showNotification(message, type = 'success', duration = 3000) {
            notificationMessage.textContent = message;
            notification.className = `notification ${type}`;
            
            // Update icon based on type
            const icon = notification.querySelector('i');
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                icon.className = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                icon.className = 'fas fa-info-circle';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function updateUI() {
            if (currentUser) {
                loginLink.style.display = 'none';
                registerLink.style.display = 'none';
                logoutLink.style.display = 'block';
                supportLink.style.display = 'block';
                
                if (currentUser.is_admin) {
                    adminLink.style.display = 'block';
                }
            } else {
                loginLink.style.display = 'block';
                registerLink.style.display = 'block';
                logoutLink.style.display = 'none';
                supportLink.style.display = 'none';
                adminLink.style.display = 'none';
            }
        }

        async function login() {
            if (isProcessing) return;
            isProcessing = true;
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const captcha = document.getElementById('login-captcha').value;
            const submitBtn = document.querySelector('#login-form-element button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading"></span> Logging in...';
                
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('captcha', captcha);

                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        id: data.user_id,
                        email: email,
                        is_admin: data.is_admin
                    };
                    updateUI();
                    showNotification(data.message, 'success');
                    showSection('home');
                    
                    // Join appropriate room via Socket.IO
                    if (socket) {
                        if (data.is_admin) {
                            socket.emit('join_admin_room');
                        } else {
                            socket.emit('join_user_room', {user_id: data.user_id});
                        }
                    }
                    
                    // Clear form
                    document.getElementById('login-form-element').reset();
                } else {
                    showNotification(data.message, 'error');
                    // Reload CAPTCHA on error
                    loadCaptcha();
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Login error:', error);
                // Reload CAPTCHA on error
                loadCaptcha();
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        }

        async function register() {
            if (isProcessing) return;
            isProcessing = true;
            
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const captcha = document.getElementById('register-captcha').value;
            const submitBtn = document.querySelector('#register-form-element button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading"></span> Registering...';
                
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('captcha', captcha);

                const response = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        id: data.user_id,
                        email: email,
                        is_admin: 0
                    };
                    updateUI();
                    showNotification(data.message, 'success');
                    showSection('home');
                    
                    // Join user room via Socket.IO
                    if (socket) {
                        socket.emit('join_user_room', {user_id: data.user_id});
                    }
                    
                    // Clear form
                    document.getElementById('register-form-element').reset();
                } else {
                    showNotification(data.message, 'error');
                    // Reload CAPTCHA on error
                    loadCaptcha();
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Registration error:', error);
                // Reload CAPTCHA on error
                loadCaptcha();
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register';
            }
        }

        async function logout() {
            try {
                const response = await fetch('/logout');
                const data = await response.json();
                
                if (data.success) {
                    currentUser = null;
                    updateUI();
                    showNotification(data.message, 'success');
                    showSection('home');
                } else {
                    showNotification('An error occurred during logout', 'error');
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Logout error:', error);
            }
        }

        async function adminLogin() {
            if (isProcessing) return;
            isProcessing = true;
            
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const captcha = document.getElementById('admin-captcha').value;
            const submitBtn = document.querySelector('#admin-login-form-element button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading"></span> Logging in...';
                
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('captcha', captcha);

                const response = await fetch('/admin/login', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = {
                        id: data.user_id,
                        email: email,
                        is_admin: 1
                    };
                    updateUI();
                    showNotification(data.message, 'success');
                    showSection('admin-dashboard');
                    loadAdminDashboard();
                    
                    // Join admin room via Socket.IO
                    if (socket) {
                        socket.emit('join_admin_room');
                    }
                    
                    // Clear form
                    document.getElementById('admin-login-form-element').reset();
                } else {
                    showNotification(data.message, 'error');
                    // Reload CAPTCHA on error
                    loadCaptcha();
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Admin login error:', error);
                // Reload CAPTCHA on error
                loadCaptcha();
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        }

        async function loadCourses() {
            try {
                const response = await fetch('/courses');
                const data = await response.json();

                if (data.courses) {
                    const coursesContainer = document.getElementById('courses-container');
                    coursesContainer.innerHTML = '';

                    data.courses.forEach(course => {
                        const courseCard = document.createElement('div');
                        courseCard.className = 'course-card';
                        courseCard.setAttribute('data-course-level', course.level);
                        
                        let statusHtml = '';
                        if (course.purchased) {
                            if (course.status === 'approved') {
                                statusHtml = `<div class="course-status purchased"><i class="fas fa-check-circle"></i> Purchased</div>`;
                            } else if (course.status === 'pending') {
                                statusHtml = `<div class="course-status pending"><i class="fas fa-clock"></i> Payment Pending</div>`;
                            } else if (course.status === 'rejected') {
                                statusHtml = `<div class="course-status rejected"><i class="fas fa-times-circle"></i> Rejected</div>`;
                            }
                        }

                        courseCard.innerHTML = `
                            <div class="course-header">${course.level}</div>
                            <div class="course-body">
                                <div class="course-description">${course.description}</div>
                                ${statusHtml}
                                <button class="btn view-course-btn" data-course-id="${course.id}" data-course-level="${course.level}" data-course-description="${course.description}" data-course-content="${course.content}" data-purchased="${course.purchased}" data-status="${course.status || ''}">View Course</button>
                            </div>
                        `;
                        
                        coursesContainer.appendChild(courseCard);
                    });

                    // Add event listeners to view course buttons
                    document.querySelectorAll('.view-course-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const courseId = btn.getAttribute('data-course-id');
                            const courseLevel = btn.getAttribute('data-course-level');
                            const courseDescription = btn.getAttribute('data-course-description');
                            const courseContent = btn.getAttribute('data-course-content');
                            const purchased = btn.getAttribute('data-purchased') === 'true';
                            const status = btn.getAttribute('data-status');
                            
                            currentCourse = {
                                id: courseId,
                                level: courseLevel,
                                description: courseDescription,
                                content: courseContent,
                                purchased: purchased,
                                status: status
                            };
                            
                            showCourseModal();
                        });
                    });
                }
            } catch (error) {
                showNotification('Failed to load courses', 'error');
                console.error('Load courses error:', error);
            }
        }

        // Update course status in real-time
        function updateCourseStatus(courseLevel, status) {
            const courseCard = document.querySelector(`[data-course-level="${courseLevel}"]`);
            if (courseCard) {
                const statusDiv = courseCard.querySelector('.course-status');
                const viewBtn = courseCard.querySelector('.view-course-btn');
                
                // Remove existing status if any
                if (statusDiv) {
                    statusDiv.remove();
                }
                
                // Add new status based on status
                if (status === 'approved') {
                    const newStatusDiv = document.createElement('div');
                    newStatusDiv.className = 'course-status purchased';
                    newStatusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Purchased';
                    viewBtn.parentNode.insertBefore(newStatusDiv, viewBtn);
                    viewBtn.setAttribute('data-purchased', 'true');
                    viewBtn.setAttribute('data-status', 'approved');
                } else if (status === 'rejected') {
                    const newStatusDiv = document.createElement('div');
                    newStatusDiv.className = 'course-status rejected';
                    newStatusDiv.innerHTML = '<i class="fas fa-times-circle"></i> Rejected';
                    viewBtn.parentNode.insertBefore(newStatusDiv, viewBtn);
                    viewBtn.setAttribute('data-purchased', 'true');
                    viewBtn.setAttribute('data-status', 'rejected');
                }
            }
        }

        function resetModal() {
            // Reset modal content
            document.getElementById('modal-purchase-section').style.display = 'none';
            document.getElementById('modal-quiz-section').style.display = 'none';
            document.getElementById('modal-resources-section').style.display = 'none';
            document.getElementById('quiz-result').style.display = 'none';
            document.getElementById('submit-quiz-btn').style.display = 'block';
            
            // Reset quiz state
            currentQuizQuestion = 0;
            quizScore = 0;
        }
        function updateResourceLinks(courseLevel) {
            const resources = courseResources[courseLevel];
            if (resources) {
                // Update all resource links based on course level
                const resourceItems = document.querySelectorAll('.resource-item');
                resourceItems[0].querySelector('a').href = resources.textbook;
                resourceItems[1].querySelector('a').href = resources.video;
                resourceItems[2].querySelector('a').href = resources.exercise;
                resourceItems[3].querySelector('a').href = resources.vocabulary;
            }
        }

        function showCourseModal() {
            resetModal();
            
            document.getElementById('modal-course-title').textContent = currentCourse.level;
            document.getElementById('modal-course-description').textContent = currentCourse.description;
            document.getElementById('modal-course-content').textContent = currentCourse.content;
            
            const purchaseSection = document.getElementById('modal-purchase-section');
            const quizSection = document.getElementById('modal-quiz-section');
            const resourcesSection = document.getElementById('modal-resources-section');
            
            if (currentCourse.purchased) {
                if (currentCourse.status === 'approved') {
                    resourcesSection.style.display = 'block';
                    quizSection.style.display = 'block';
                    loadQuiz();
                    
                    // UPDATE RESOURCE LINKS FOR THIS COURSE
                    updateResourceLinks(currentCourse.level);
                } else if (currentCourse.status === 'pending') {
                    purchaseSection.innerHTML = `
                        <h4><i class="fas fa-clock"></i> Payment Pending</h4>
                        <p>Your payment is being processed. Please wait for admin approval.</p>
                        <p>Status: <span class="course-status pending"><i class="fas fa-clock"></i> Pending</span></p>
                    `;
                    purchaseSection.style.display = 'block';
                } else if (currentCourse.status === 'rejected') {
                    purchaseSection.innerHTML = `
                        <h4><i class="fas fa-times-circle"></i> Purchase Rejected</h4>
                        <p>Your purchase has been rejected. Please contact support for more information.</p>
                        <p>Status: <span class="course-status rejected"><i class="fas fa-times-circle"></i> Rejected</span></p>
                    `;
                    purchaseSection.style.display = 'block';
                }
            } else {
                purchaseSection.innerHTML = `
                    <h4><i class="fas fa-qrcode"></i> Purchase via KBZ Pay</h4>
                    <div class="qr-container">
                        <div id="qr-loading" class="qr-loading">
                            <div class="loading"></div>
                        </div>
                        <img id="modal-qr-code" src="" alt="KBZ Pay QR Code" style="display: none;">
                    </div>
                    <p>Scan the QR code with KBZ Pay app to complete the payment.</p>
                    <button class="btn" id="ive-paid-btn">I've Paid</button>
                `;
                purchaseSection.style.display = 'block';
                
                // Load QR code
                loadQRCode();
                
                // Re-attach event listener to the new button
                document.getElementById('ive-paid-btn').addEventListener('click', () => {
                    if (!isProcessing) {
                        markAsPaid();
                    }
                });
            }
            
            courseModal.style.display = 'flex';
        }

        // Load QR code from server
        async function loadQRCode() {
            const qrLoading = document.getElementById('qr-loading');
            const qrImage = document.getElementById('modal-qr-code');
            
            // Show loading
            qrLoading.style.display = 'flex';
            qrImage.style.display = 'none';
            
            try {
                // Use the correct URL for the QR code image
                const qrUrl = '/static/images/kpay.jpg';
                
                // Create a new image to test if it loads
                const testImg = new Image();
                testImg.onload = function() {
                    qrImage.src = qrUrl;
                    qrImage.style.display = 'block';
                    qrLoading.style.display = 'none';
                };
                testImg.onerror = function() {
                    qrLoading.innerHTML = '<p style="color: var(--danger-color);">Failed to load QR code. Please try again.</p>';
                };
                testImg.src = qrUrl;
                
            } catch (error) {
                console.error('Error loading QR code:', error);
                qrLoading.innerHTML = '<p style="color: var(--danger-color);">Failed to load QR code. Please try again.</p>';
            }
        }

        async function markAsPaid() {
            if (isProcessing) return;
            isProcessing = true;
            
            const paidBtn = document.getElementById('ive-paid-btn');
            
            try {
                paidBtn.disabled = true;
                paidBtn.innerHTML = '<span class="loading"></span> Processing...';
                
                const response = await fetch(`/purchase/${currentCourse.level}`);
                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    currentCourse.purchased = true;
                    currentCourse.status = 'pending';
                    
                    // Update the course status in the modal
                    document.getElementById('modal-purchase-section').innerHTML = `
                        <h4><i class="fas fa-check-circle"></i> Payment Received</h4>
                        <p>Your payment has been recorded. Please wait for admin approval.</p>
                        <p>Status: <span class="course-status pending"><i class="fas fa-clock"></i> Pending</span></p>
                    `;
                    
                    // Update course card
                    updateCourseStatus(currentCourse.level, 'pending');
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Purchase error:', error);
            } finally {
                isProcessing = false;
                paidBtn.disabled = false;
                paidBtn.textContent = "I've Paid";
            }
        }

        function loadQuiz() {
            currentQuizQuestion = 0;
            quizScore = 0;
            showQuizQuestion();
        }

        function showQuizQuestion() {
            if (currentQuizQuestion >= quizQuestions.length) {
                showQuizResult();
                return;
            }

            const question = quizQuestions[currentQuizQuestion];
            document.getElementById('quiz-question').textContent = `Question ${currentQuizQuestion + 1}: ${question.question}`;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'quiz-option';
                optionElement.textContent = option;
                optionElement.addEventListener('click', () => selectQuizOption(index));
                optionsContainer.appendChild(optionElement);
            });
        }

        function selectQuizOption(index) {
            document.querySelectorAll('.quiz-option').forEach((option, i) => {
                option.classList.remove('selected');
                if (i === index) {
                    option.classList.add('selected');
                }
            });
        }

        function submitQuiz() {
            const selectedOption = document.querySelector('.quiz-option.selected');
            
            if (!selectedOption) {
                showNotification('Please select an answer', 'warning');
                return;
            }
            
            const selectedIndex = Array.from(document.querySelectorAll('.quiz-option')).indexOf(selectedOption);
            
            if (selectedIndex === quizQuestions[currentQuizQuestion].correct) {
                quizScore++;
            }
            
            currentQuizQuestion++;
            showQuizQuestion();
        }

        function showQuizResult() {
            const resultContainer = document.getElementById('quiz-result');
            const percentage = Math.round((quizScore / quizQuestions.length) * 100);
            
            let resultClass = 'error';
            let resultMessage = `You scored ${quizScore} out of ${quizQuestions.length} (${percentage}%).`;
            
            if (percentage >= 70) {
                resultClass = 'success';
                resultMessage += ' Great job!';
            } else if (percentage >= 50) {
                resultMessage += ' Keep practicing!';
            } else {
                resultMessage += ' You need more practice.';
            }
            
            resultContainer.className = `quiz-result ${resultClass}`;
            resultContainer.textContent = resultMessage;
            resultContainer.style.display = 'block';
            
            document.getElementById('quiz-options').innerHTML = '';
            document.getElementById('submit-quiz-btn').style.display = 'none';
        }

        async function loadAdminDashboard() {
            try {
                const response = await fetch('/admin/dashboard/data');
                const data = await response.json();
                
                if (data.purchases) {
                    loadPurchasesIntoTable(data.purchases);
                }
                
                if (data.support_messages) {
                    loadSupportMessagesIntoTable(data.support_messages);
                }
                
                if (data.teacher_messages) {
                    loadTeacherMessagesIntoTable(data.teacher_messages);
                }
            } catch (error) {
                showNotification('Error loading admin dashboard', 'error');
                console.error('Error loading admin dashboard:', error);
            }
        }

        // Load purchases into admin table
        function loadPurchasesIntoTable(purchases) {
            const tbody = document.getElementById('admin-purchases-tbody');
            tbody.innerHTML = '';
            
            purchases.forEach(purchase => {
                addPurchaseRow(purchase);
            });
        }

        // Add purchase row to admin table
        function addPurchaseRow(purchase) {
            const tbody = document.getElementById('admin-purchases-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-purchase-id', purchase.id);
            
            let statusClass = '';
            if (purchase.status === 'pending') {
                statusClass = 'pending';
            } else if (purchase.status === 'approved') {
                statusClass = 'approved';
            } else if (purchase.status === 'rejected') {
                statusClass = 'rejected';
            }
            
            let actionButtons = '';
            if (purchase.status === 'pending') {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-success approve-btn" data-id="${purchase.id}">Approve</button>
                        <button class="btn btn-danger reject-btn" data-id="${purchase.id}">Reject</button>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td>${purchase.id}</td>
                <td>${purchase.email}</td>
                <td>${purchase.level}</td>
                <td><span class="status-badge ${statusClass}">${purchase.status}</span></td>
                <td>${actionButtons}</td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listeners to approve/reject buttons
            const approveBtn = row.querySelector('.approve-btn');
            const rejectBtn = row.querySelector('.reject-btn');
            
            if (approveBtn) {
                approveBtn.addEventListener('click', () => {
                    approvePurchase(approveBtn.getAttribute('data-id'));
                });
            }
            
            if (rejectBtn) {
                rejectBtn.addEventListener('click', () => {
                    rejectPurchase(rejectBtn.getAttribute('data-id'));
                });
            }
        }

        // Add new purchase with animation
        function addNewPurchaseToTable(purchase) {
            const tbody = document.getElementById('admin-purchases-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-purchase-id', purchase.id);
            row.className = 'new-purchase';
            
            row.innerHTML = `
                <td>${purchase.id}</td>
                <td>${purchase.user_email}</td>
                <td>${purchase.course_level}</td>
                <td><span class="status-badge pending">${purchase.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-success approve-btn" data-id="${purchase.id}">Approve</button>
                        <button class="btn btn-danger reject-btn" data-id="${purchase.id}">Reject</button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listeners
            row.querySelector('.approve-btn').addEventListener('click', () => {
                approvePurchase(purchase.id);
            });
            
            row.querySelector('.reject-btn').addEventListener('click', () => {
                rejectPurchase(purchase.id);
            });
        }

        // Update purchase in table
        function updatePurchaseInTable(purchase, action) {
            const row = document.querySelector(`[data-purchase-id="${purchase.id}"]`);
            if (row) {
                const statusCell = row.querySelector('.status-badge');
                const actionCell = row.querySelector('td:last-child');
                
                statusCell.className = `status-badge ${purchase.status}`;
                statusCell.textContent = purchase.status;
                
                if (purchase.status !== 'pending') {
                    actionCell.innerHTML = '';
                }
                
                // Add highlight animation
                row.classList.add('updated-purchase');
                setTimeout(() => {
                    row.classList.remove('updated-purchase');
                }, 2000);
            }
        }

        // Load support messages into admin table
        function loadSupportMessagesIntoTable(messages) {
            const tbody = document.getElementById('admin-support-tbody');
            tbody.innerHTML = '';
            
            messages.forEach(message => {
                addSupportMessageRow(message);
            });
        }

        // Add support message row to admin table
        function addSupportMessageRow(message) {
            const tbody = document.getElementById('admin-support-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-message-id', message.id);
            
            let statusClass = '';
            if (message.status === 'pending') {
                statusClass = 'pending';
            } else if (message.status === 'replied') {
                statusClass = 'replied';
            }
            
            let actionButtons = '';
            if (message.status === 'pending') {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-success reply-btn" data-id="${message.id}" data-email="${message.email}" data-type="${message.message_type}" data-subject="${message.subject}" data-message="${message.message}">Reply</button>
                    </div>
                `;
            }
            
            row.innerHTML = `
                <td>${message.id}</td>
                <td>${message.email}</td>
                <td><span class="support-message-type ${message.message_type}">${message.message_type}</span></td>
                <td>${message.subject}</td>
                <td><span class="status-badge ${statusClass}">${message.status}</span></td>
                <td>${actionButtons}</td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listener to reply button
            const replyBtn = row.querySelector('.reply-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', () => {
                    openReplyModal(
                        replyBtn.getAttribute('data-id'),
                        replyBtn.getAttribute('data-email'),
                        replyBtn.getAttribute('data-type'),
                        replyBtn.getAttribute('data-subject'),
                        replyBtn.getAttribute('data-message')
                    );
                });
            }
        }

        // Add new support message with animation
        function addNewSupportMessageToTable(message) {
            const tbody = document.getElementById('admin-support-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-message-id', message.id);
            row.className = 'new-purchase';
            
            row.innerHTML = `
                <td>${message.id}</td>
                <td>${message.user_email}</td>
                <td><span class="support-message-type ${message.message_type}">${message.message_type}</span></td>
                <td>${message.subject}</td>
                <td><span class="status-badge pending">${message.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-success reply-btn" data-id="${message.id}" data-email="${message.user_email}" data-type="${message.message_type}" data-subject="${message.subject}" data-message="${message.message}">Reply</button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listener
            row.querySelector('.reply-btn').addEventListener('click', () => {
                openReplyModal(
                    message.id,
                    message.user_email,
                    message.message_type,
                    message.subject,
                    message.message
                );
            });
        }

        // Update support message in table
        function updateSupportMessageInTable(message, action) {
            const row = document.querySelector(`[data-message-id="${message.id}"]`);
            if (row) {
                const statusCell = row.querySelector('.status-badge');
                const actionCell = row.querySelector('td:last-child');
                
                statusCell.className = `status-badge ${message.status}`;
                statusCell.textContent = message.status;
                
                if (message.status !== 'pending') {
                    actionCell.innerHTML = '';
                }
                
                // Add highlight animation
                row.classList.add('updated-purchase');
                setTimeout(() => {
                    row.classList.remove('updated-purchase');
                }, 2000);
            }
        }

        // Load teacher messages into admin table
        function loadTeacherMessagesIntoTable(messages) {
            const tbody = document.getElementById('admin-teacher-tbody');
            tbody.innerHTML = '';
            
            messages.forEach(message => {
                addTeacherMessageRow(message);
            });
        }

        // Add teacher message row to admin table
        function addTeacherMessageRow(message) {
            const tbody = document.getElementById('admin-teacher-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-message-id', message.id);
            
            let statusClass = '';
            if (message.status === 'pending') {
                statusClass = 'pending';
            } else if (message.status === 'replied') {
                statusClass = 'replied';
            }
            
            let actionButtons = '';
            if (message.status === 'pending') {
                actionButtons = `
                    <div class="action-buttons">
                        <button class="btn btn-success view-teacher-btn" data-id="${message.id}" data-email="${message.email}" data-subject="${message.subject}" data-message="${message.message}" data-file="${message.file_path}">View</button>
                        <button class="btn btn-success reply-teacher-btn" data-id="${message.id}" data-email="${message.email}" data-subject="${message.subject}" data-message="${message.message}">Reply</button>
                    </div>
                `;
            }
            
            const fileHtml = message.file_path ? 
                `<a href="/download/${message.file_path}" class="btn btn-outline" download><i class="fas fa-download"></i> Download</a>` : 
                'No file';
            
            row.innerHTML = `
                <td>${message.id}</td>
                <td>${message.email}</td>
                <td>${message.subject}</td>
                <td>${fileHtml}</td>
                <td><span class="status-badge ${statusClass}">${message.status}</span></td>
                <td>${actionButtons}</td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listener to view button
            const viewBtn = row.querySelector('.view-teacher-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', () => {
                    openTeacherMessageModal(
                        viewBtn.getAttribute('data-id'),
                        viewBtn.getAttribute('data-email'),
                        viewBtn.getAttribute('data-subject'),
                        viewBtn.getAttribute('data-message'),
                        viewBtn.getAttribute('data-file')
                    );
                });
            }
            
            // Add event listener to reply button
            const replyBtn = row.querySelector('.reply-teacher-btn');
            if (replyBtn) {
                replyBtn.addEventListener('click', () => {
                    openTeacherReplyModal(
                        replyBtn.getAttribute('data-id'),
                        replyBtn.getAttribute('data-email'),
                        replyBtn.getAttribute('data-subject'),
                        replyBtn.getAttribute('data-message')
                    );
                });
            }
        }

        // Add new teacher message with animation
        function addNewTeacherMessageToTable(message) {
            const tbody = document.getElementById('admin-teacher-tbody');
            const row = document.createElement('tr');
            row.setAttribute('data-message-id', message.id);
            row.className = 'new-purchase';
            
            const fileHtml = message.file_path ? 
                `<a href="/download/${message.file_path}" class="btn btn-outline" download><i class="fas fa-download"></i> Download</a>` : 
                'No file';
            
            row.innerHTML = `
                <td>${message.id}</td>
                <td>${message.user_email}</td>
                <td>${message.subject}</td>
                <td>${fileHtml}</td>
                <td><span class="status-badge pending">${message.status}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-success view-teacher-btn" data-id="${message.id}" data-email="${message.user_email}" data-subject="${message.subject}" data-message="${message.message}" data-file="${message.file_path}">View</button>
                        <button class="btn btn-success reply-teacher-btn" data-id="${message.id}" data-email="${message.user_email}" data-subject="${message.subject}" data-message="${message.message}">Reply</button>
                    </div>
                </td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);
            
            // Add event listener
            row.querySelector('.view-teacher-btn').addEventListener('click', () => {
                openTeacherMessageModal(
                    message.id,
                    message.user_email,
                    message.subject,
                    message.message,
                    message.file_path
                );
            });
            
            row.querySelector('.reply-teacher-btn').addEventListener('click', () => {
                openTeacherReplyModal(
                    message.id,
                    message.user_email,
                    message.subject,
                    message.message
                );
            });
        }

        // Update teacher message in table
        function updateTeacherMessageInTable(message, action) {
            const row = document.querySelector(`[data-message-id="${message.id}"]`);
            if (row) {
                const statusCell = row.querySelector('.status-badge');
                const actionCell = row.querySelector('td:last-child');
                
                statusCell.className = `status-badge ${message.status}`;
                statusCell.textContent = message.status;
                
                if (message.status !== 'pending') {
                    // Keep the view button but remove reply button
                    const viewBtn = actionCell.querySelector('.view-teacher-btn');
                    actionCell.innerHTML = '';
                    if (viewBtn) {
                        actionCell.appendChild(viewBtn);
                    }
                }
                
                // Add highlight animation
                row.classList.add('updated-purchase');
                setTimeout(() => {
                    row.classList.remove('updated-purchase');
                }, 2000);
            }
        }

        // Open reply modal
        function openReplyModal(messageId, email, type, subject, message) {
            document.getElementById('reply-message-id').value = messageId;
            document.getElementById('reply-message-email').textContent = email;
            document.getElementById('reply-message-type').textContent = type;
            document.getElementById('reply-message-type').className = `support-message-type ${type}`;
            document.getElementById('reply-message-subject').textContent = subject;
            document.getElementById('reply-message-content').textContent = message;
            document.getElementById('reply-message-type-field').value = 'support';
            document.getElementById('reply-message').focus();
            
            supportReplyModal.style.display = 'flex';
        }

        // Open teacher reply modal
        function openTeacherReplyModal(messageId, email, subject, message) {
            document.getElementById('reply-message-id').value = messageId;
            document.getElementById('reply-message-email').textContent = email;
            document.getElementById('reply-message-type').textContent = 'teacher';
            document.getElementById('reply-message-type').className = `support-message-type teacher`;
            document.getElementById('reply-message-subject').textContent = subject;
            document.getElementById('reply-message-content').textContent = message;
            document.getElementById('reply-message-type-field').value = 'teacher';
            document.getElementById('reply-message').focus();
            
            supportReplyModal.style.display = 'flex';
        }

        // Open teacher message view modal
        function openTeacherMessageModal(messageId, email, subject, message, filePath) {
            document.getElementById('teacher-view-subject').textContent = subject;
            document.getElementById('teacher-view-message').textContent = message;
            document.getElementById('teacher-view-email').textContent = `From: ${email}`;
            
            // Add file attachment if exists
            const fileContainer = document.getElementById('teacher-view-file-container');
            if (filePath) {
                const fileName = filePath.split('/').pop();
                fileContainer.innerHTML = `
                    <a href="/download/${filePath}" class="file-attachment" download>
                        <i class="fas fa-paperclip"></i> ${fileName}
                    </a>
                `;
            } else {
                fileContainer.innerHTML = '';
            }
            
            // Check if there's a reply
            // This would need to be fetched from the server or stored in the message data
            // For now, we'll check if the message status is 'replied'
            const messageRow = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageRow) {
                const statusBadge = messageRow.querySelector('.status-badge');
                if (statusBadge && statusBadge.textContent === 'replied') {
                    // Show reply section (you might need to fetch the actual reply)
                    document.getElementById('teacher-reply-section').style.display = 'block';
                    document.getElementById('teacher-view-reply').textContent = 'Reply has been sent. Please check your messages.';
                } else {
                    document.getElementById('teacher-reply-section').style.display = 'none';
                }
            }
            
            teacherMessageModal.style.display = 'flex';
        }

        // Load user messages
        async function loadUserMessages() {
            try {
                const response = await fetch('/user/messages');
                const data = await response.json();
                
                if (data.support_messages) {
                    displaySupportMessages(data.support_messages);
                }
                
                if (data.teacher_messages) {
                    displayTeacherMessages(data.teacher_messages);
                }
            } catch (error) {
                console.error('Error loading user messages:', error);
            }
        }

        // Display support messages
        function displaySupportMessages(messages) {
            const container = document.getElementById('support-messages-list');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--dark-gray);">No support messages yet.</p>';
                return;
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item';
                messageDiv.setAttribute('data-message-id', msg.id);
                
                const sentClass = msg.reply ? 'received' : 'sent';
                messageDiv.classList.add(sentClass);
                
                messageDiv.innerHTML = `
                    <div class="message-header">You</div>
                    <div class="message-content">${msg.message}</div>
                    <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
                `;
                
                container.appendChild(messageDiv);
                
                if (msg.reply) {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'message-item received';
                    
                    replyDiv.innerHTML = `
                        <div class="message-header">Admin</div>
                        <div class="message-content">${msg.reply}</div>
                        <div class="message-time">${new Date(msg.reply_date).toLocaleString()}</div>
                    `;
                    
                    container.appendChild(replyDiv);
                }
            });
        }

        // Display teacher messages
        function displayTeacherMessages(messages) {
            const container = document.getElementById('teacher-messages-list');
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--dark-gray);">No teacher messages yet.</p>';
                return;
            }
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message-item';
                messageDiv.setAttribute('data-message-id', msg.id);
                
                const sentClass = msg.reply ? 'received' : 'sent';
                messageDiv.classList.add(sentClass);
                
                let fileHtml = '';
                if (msg.file_path) {
                    const fileName = msg.file_path.split('/').pop();
                    fileHtml = `<a href="/download/${msg.file_path}" class="file-attachment" download><i class="fas fa-paperclip"></i> ${fileName}</a>`;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">You</div>
                    <div class="message-content">${msg.message}</div>
                    ${fileHtml}
                    <div class="message-time">${new Date(msg.created_at).toLocaleString()}</div>
                `;
                
                container.appendChild(messageDiv);
                
                if (msg.reply) {
                    const replyDiv = document.createElement('div');
                    replyDiv.className = 'message-item received';
                    
                    replyDiv.innerHTML = `
                        <div class="message-header">Teacher</div>
                        <div class="message-content">${msg.reply}</div>
                        <div class="message-time">${new Date(msg.reply_date).toLocaleString()}</div>
                    `;
                    
                    container.appendChild(replyDiv);
                }
            });
        }

        // Update support message in UI
        function updateSupportMessageInUI(messageId, reply) {
            const messageDiv = document.querySelector(`.message-item[data-message-id="${messageId}"]`);
            if (messageDiv) {
                // Create reply div
                const replyDiv = document.createElement('div');
                replyDiv.className = 'message-item received';
                
                replyDiv.innerHTML = `
                    <div class="message-header">Admin</div>
                    <div class="message-content">${reply}</div>
                    <div class="message-time">${new Date().toLocaleString()}</div>
                `;
                
                // Insert after the original message
                messageDiv.parentNode.insertBefore(replyDiv, messageDiv.nextSibling);
                
                // Scroll to the new reply
                replyDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Update teacher message in UI
        function updateTeacherMessageInUI(messageId, reply) {
            const messageDiv = document.querySelector(`.message-item[data-message-id="${messageId}"]`);
            if (messageDiv) {
                // Create reply div
                const replyDiv = document.createElement('div');
                replyDiv.className = 'message-item received';
                
                replyDiv.innerHTML = `
                    <div class="message-header">Teacher</div>
                    <div class="message-content">${reply}</div>
                    <div class="message-time">${new Date().toLocaleString()}</div>
                `;
                
                // Insert after the original message
                messageDiv.parentNode.insertBefore(replyDiv, messageDiv.nextSibling);
                
                // Scroll to the new reply
                replyDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Submit support message
        async function submitSupportMessage() {
            if (isProcessing) return;
            isProcessing = true;
            
            const message_type = document.getElementById('support-type').value;
            const subject = document.getElementById('support-subject').value;
            const message = document.getElementById('support-message').value;
            const submitBtn = document.querySelector('#support-form-element button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading"></span> Sending...';
                
                const formData = new FormData();
                formData.append('message_type', message_type);
                formData.append('subject', subject);
                formData.append('message', message);
                
                // Add file if it's a teacher message
                if (message_type === 'teacher') {
                    const fileInput = document.getElementById('support-file');
                    if (fileInput.files[0]) {
                        formData.append('file', fileInput.files[0]);
                    }
                }

                let response;
                if (message_type === 'teacher') {
                    response = await fetch('/teacher/submit', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    response = await fetch('/support/submit', {
                        method: 'POST',
                        body: formData
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    
                    // Reset form
                    document.getElementById('support-form-element').reset();
                    supportFormContainer.classList.remove('active');
                    
                    // Reload messages
                    loadUserMessages();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Submit support message error:', error);
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Message';
            }
        }

        // Submit reply
        async function submitReply() {
            if (isProcessing) return;
            isProcessing = true;
            
            const messageId = document.getElementById('reply-message-id').value;
            const reply = document.getElementById('reply-message').value;
            const messageType = document.getElementById('reply-message-type-field').value;
            const submitBtn = document.querySelector('#reply-form-element button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading"></span> Sending...';
                
                const formData = new FormData();
                formData.append('reply', reply);

                let response;
                if (messageType === 'teacher') {
                    response = await fetch(`/admin/teacher/reply/${messageId}`, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    response = await fetch(`/admin/support/reply/${messageId}`, {
                        method: 'POST',
                        body: formData
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(data.message, 'success');
                    supportReplyModal.style.display = 'none';
                    document.getElementById('reply-form-element').reset();
                } else {
                    showNotification(data.message, 'error');
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Submit reply error:', error);
            } finally {
                isProcessing = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Reply';
            }
        }

        async function approvePurchase(purchaseId) {
            if (isProcessing) return;
            isProcessing = true;
            
            const approveBtn = document.querySelector(`.approve-btn[data-id="${purchaseId}"]`);
            const rejectBtn = document.querySelector(`.reject-btn[data-id="${purchaseId}"]`);
            
            try {
                if (approveBtn) approveBtn.disabled = true;
                if (rejectBtn) rejectBtn.disabled = true;
                
                if (approveBtn) approveBtn.innerHTML = '<span class="loading"></span>';
                
                const response = await fetch(`/admin/approve/${purchaseId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Socket.IO will handle the UI update
                } else {
                    showNotification(data.message, 'error');
                    // Re-enable buttons on error
                    if (approveBtn) {
                        approveBtn.disabled = false;
                        approveBtn.textContent = 'Approve';
                    }
                    if (rejectBtn) {
                        rejectBtn.disabled = false;
                        rejectBtn.textContent = 'Reject';
                    }
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Approve purchase error:', error);
                // Re-enable buttons on error
                if (approveBtn) {
                    approveBtn.disabled = false;
                    approveBtn.textContent = 'Approve';
                }
                if (rejectBtn) {
                    rejectBtn.disabled = false;
                    rejectBtn.textContent = 'Reject';
                }
            } finally {
                isProcessing = false;
            }
        }

        async function rejectPurchase(purchaseId) {
            if (isProcessing) return;
            isProcessing = true;
            
            const approveBtn = document.querySelector(`.approve-btn[data-id="${purchaseId}"]`);
            const rejectBtn = document.querySelector(`.reject-btn[data-id="${purchaseId}"]`);
            
            try {
                if (approveBtn) approveBtn.disabled = true;
                if (rejectBtn) rejectBtn.disabled = true;
                
                if (rejectBtn) rejectBtn.innerHTML = '<span class="loading"></span>';
                
                const response = await fetch(`/admin/reject/${purchaseId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Socket.IO will handle the UI update
                } else {
                    showNotification(data.message, 'error');
                    // Re-enable buttons on error
                    if (approveBtn) {
                        approveBtn.disabled = false;
                        approveBtn.textContent = 'Approve';
                    }
                    if (rejectBtn) {
                        rejectBtn.disabled = false;
                        rejectBtn.textContent = 'Reject';
                    }
                }
            } catch (error) {
                showNotification('An error occurred. Please try again.', 'error');
                console.error('Reject purchase error:', error);
                // Re-enable buttons on error
                if (approveBtn) {
                    approveBtn.disabled = false;
                    approveBtn.textContent = 'Approve';
                }
                if (rejectBtn) {
                    rejectBtn.disabled = false;
                    rejectBtn.textContent = 'Reject';
                }
            } finally {
                isProcessing = false;
            }
        }

        // Check if user is logged in on page load
        async function checkLoginStatus() {
            try {
                const response = await fetch('/user/status');
                const data = await response.json();
                
                if (data.logged_in) {
                    currentUser = {
                        id: data.user_id,
                        email: data.email,
                        is_admin: data.is_admin
                    };
                    updateUI();
                    
                    // Join appropriate room via Socket.IO
                    if (socket) {
                        if (data.is_admin) {
                            socket.emit('join_admin_room');
                        } else {
                            socket.emit('join_user_room', {user_id: data.user_id});
                        }
                    }
                }
            } catch (error) {
                console.error('Check login status error:', error);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Socket.IO
            initializeSocket();
            
            // Load initial CAPTCHA
            loadCaptcha();
            
            // Check login status
            checkLoginStatus();
            
            // Check if we're on a specific page based on URL
            const path = window.location.pathname;
            
            if (path === '/admin') {
                showSection('admin-login');
            } else if (path === '/admin/dashboard') {
                if (currentUser && currentUser.is_admin) {
                    showSection('admin-dashboard');
                    loadAdminDashboard();
                } else {
                    showSection('admin-login');
                }
            } else if (path === '/support') {
                if (currentUser) {
                    showSection('support');
                    loadUserMessages();
                } else {
                    showSection('auth');
                    showLoginForm();
                }
            } else {
                showSection('home');
            }
        });
    </script>
</body>
</html>
